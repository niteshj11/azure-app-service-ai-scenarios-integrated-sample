{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "5876710862463163809"
    }
  },
  "parameters": {
    "environmentName": {
      "type": "string",
      "defaultValue": "[replace(resourceGroup().name, 'rg-', '')]",
      "minLength": 1,
      "maxLength": 64,
      "metadata": {
        "description": "Name of the environment provided by azd"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "azd": {
          "type": "location"
        },
        "description": "Primary location for all resources"
      },
      "minLength": 1
    },
    "principalId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Id of the user or app to assign application roles"
      }
    },
    "aSetupChoice": {
      "type": "string",
      "defaultValue": "",
      "allowedValues": [
        "new",
        "existing",
        ""
      ],
      "metadata": {
        "description": "Choose: new (create AI services) or existing (use your AI Foundry project)"
      }
    },
    "bFoundryEndpoint": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Your existing AI Foundry project endpoint URL (collected conditionally)"
      }
    },
    "cChatModelName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Your chat model deployment name (collected conditionally)"
      }
    },
    "dAudioModelName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Your audio model deployment name (collected conditionally)"
      }
    },
    "existingAISubscriptionId": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]",
      "metadata": {
        "description": "Subscription ID where your existing AI Foundry project is located"
      }
    },
    "existingAIResourceGroupName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "Resource Group name where your existing AI Foundry project is located"
      }
    },
    "enableManagedIdentity": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Managed Identity for the App Service (required for Azure AI integration)"
      }
    },
    "enableApplicationInsights": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable Application Insights monitoring"
      }
    },
    "aiProjectName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The Azure AI Foundry Hub resource name. If omitted will be generated"
      }
    },
    "aiServicesName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The AI Services resource name. If omitted will be generated"
      }
    },
    "storageAccountName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The Azure Storage Account resource name. If omitted will be generated"
      }
    },
    "appServicePlanName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The App Service plan name. If omitted will be generated"
      }
    },
    "externalAzureAIEndpoint": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Legacy parameter - use aiFoundryMode instead"
      }
    },
    "chatModelFormat": {
      "type": "string",
      "defaultValue": "OpenAI",
      "allowedValues": [
        "Microsoft",
        "OpenAI"
      ],
      "metadata": {
        "description": "Format of the chat model to deploy"
      }
    },
    "chatModelName": {
      "type": "string",
      "defaultValue": "gpt-4o-mini",
      "metadata": {
        "description": "Name of the chat model to deploy"
      }
    },
    "chatModelVersion": {
      "type": "string",
      "defaultValue": "2024-07-18",
      "metadata": {
        "description": "Version of the chat model to deploy"
      }
    },
    "chatDeploymentSku": {
      "type": "string",
      "defaultValue": "GlobalStandard",
      "metadata": {
        "description": "Sku of the chat deployment"
      }
    },
    "chatDeploymentCapacity": {
      "type": "int",
      "defaultValue": 30,
      "metadata": {
        "description": "Capacity of the chat deployment"
      }
    },
    "enableAzureMonitorTracing": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Do we want to use the Azure Monitor tracing"
      }
    },
    "azureTracingGenAIContentRecordingEnabled": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Do we want to use the Azure Monitor tracing for GenAI content recording"
      }
    },
    "templateValidationMode": {
      "type": "bool",
      "defaultValue": false
    },
    "seed": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Random seed to be used during generation of new resources suffixes."
      }
    }
  },
  "variables": {
    "$fxv#0": {
      "analysisServicesServers": "as",
      "apiManagementService": "apim-",
      "appConfigurationConfigurationStores": "appcs-",
      "appManagedEnvironments": "cae-",
      "appContainerApps": "ca-",
      "authorizationPolicyDefinitions": "policy-",
      "automationAutomationAccounts": "aa-",
      "blueprintBlueprints": "bp-",
      "blueprintBlueprintsArtifacts": "bpa-",
      "cacheRedis": "redis-",
      "cdnProfiles": "cdnp-",
      "cdnProfilesEndpoints": "cdne-",
      "cognitiveServicesAccounts": "cog-",
      "cognitiveServicesFormRecognizer": "cog-fr-",
      "cognitiveServicesTextAnalytics": "cog-ta-",
      "computeAvailabilitySets": "avail-",
      "computeCloudServices": "cld-",
      "computeDiskEncryptionSets": "des-",
      "computeDisks": "disk-",
      "computeDisksOs": "osdisk-",
      "computeGalleries": "gal-",
      "computeSnapshots": "snap-",
      "computeVirtualMachines": "vm-",
      "computeVirtualMachineScaleSets": "vmss-",
      "containerInstanceContainerGroups": "ci-",
      "containerRegistryRegistries": "cr-",
      "containerServiceManagedClusters": "aks-",
      "databricksWorkspaces": "dbw-",
      "dataFactoryFactories": "adf-",
      "dataLakeAnalyticsAccounts": "dla-",
      "dataLakeStoreAccounts": "dls-",
      "dataMigrationServices": "dms-",
      "dBforMySQLServers": "mysql-",
      "dBforPostgreSQLServers": "psql-",
      "devicesIotHubs": "iot-",
      "devicesProvisioningServices": "provs-",
      "devicesProvisioningServicesCertificates": "pcert-",
      "documentDBDatabaseAccounts": "cosmos-",
      "eventGridDomains": "evgd-",
      "eventGridSubscriptions": "evgs-",
      "eventGridTopics": "evgt-",
      "eventHubNamespaces": "evhns-",
      "eventHubNamespacesEventHubs": "evh-",
      "hdInsightClustersHadoop": "hadoop-",
      "hdInsightClustersHbase": "hbase-",
      "hdInsightClustersKafka": "kafka-",
      "hdInsightClustersMl": "mls-",
      "hdInsightClustersSpark": "spark-",
      "hdInsightClustersStorm": "storm-",
      "hybridComputeMachines": "arcs-",
      "insightsActionGroups": "ag-",
      "insightsComponents": "appi-",
      "keyVaultVaults": "kv-",
      "kubernetesConnectedClusters": "arck-",
      "kustoClusters": "dec-",
      "kustoClustersDatabases": "dedb-",
      "loadTesting": "lt-",
      "logicIntegrationAccounts": "ia-",
      "logicWorkflows": "logic-",
      "machineLearningServicesWorkspaces": "mlw-",
      "managedIdentityUserAssignedIdentities": "id-",
      "managementManagementGroups": "mg-",
      "mapsAccounts": "map-",
      "mariaDBServers": "maria-",
      "networkApplicationGateways": "agw-",
      "networkApplicationSecurityGroups": "asg-",
      "networkAzureFirewalls": "afw-",
      "networkBastionHosts": "bas-",
      "networkConnections": "con-",
      "networkDnsZones": "dnsz-",
      "networkExpressRouteCircuits": "erc-",
      "networkFirewallPolicies": "afwp-",
      "networkFirewallPoliciesWebApplication": "waf-",
      "networkFirewallPoliciesRuleGroups": "wafrg-",
      "networkFrontDoors": "fd-",
      "networkFrontdoorWebApplicationFirewallPolicies": "fdfp-",
      "networkLoadBalancers": "lb-",
      "networkLoadBalancersInbound": "lbi-",
      "networkLoadBalancersInternal": "lbi-",
      "networkLoadBalancersOutbound": "lbo-",
      "networkLocalNetworkGateways": "lgw-",
      "networkNatGateways": "ng-",
      "networkNetworkInterfaces": "nic-",
      "networkNetworkSecurityGroups": "nsg-",
      "networkNetworkSecurityGroupsSecurityRules": "nsgsr-",
      "networkNetworkWatchers": "nw-",
      "networkPrivateDnsZones": "pdnsz-",
      "networkPrivateLinkServices": "pl-",
      "networkPublicIPAddresses": "pip-",
      "networkPublicIPPrefixes": "ippre-",
      "networkRouteFilters": "rf-",
      "networkRouteTables": "rt-",
      "networkRouteTablesRoutes": "udr-",
      "networkTrafficManagerProfiles": "traf-",
      "networkVirtualNetworkGateways": "vgw-",
      "networkVirtualNetworks": "vnet-",
      "networkVirtualNetworksSubnets": "snet-",
      "networkVirtualNetworksVirtualNetworkPeerings": "peer-",
      "networkVirtualWans": "vwan-",
      "networkVpnGateways": "vpng-",
      "networkVpnGatewaysVpnConnections": "vcn-",
      "networkVpnGatewaysVpnSites": "vst-",
      "notificationHubsNamespaces": "ntfns-",
      "notificationHubsNamespacesNotificationHubs": "ntf-",
      "operationalInsightsWorkspaces": "log-",
      "portalDashboards": "dash-",
      "powerBIDedicatedCapacities": "pbi-",
      "purviewAccounts": "pview-",
      "recoveryServicesVaults": "rsv-",
      "recoveryServicesVaultsBackupPolicies": "bkpol-",
      "resourcesResourceGroups": "rg-",
      "searchSearchServices": "srch-",
      "serviceBusNamespaces": "sb-",
      "serviceBusNamespacesQueues": "sbq-",
      "serviceBusNamespacesTopics": "sbt-",
      "serviceEndPointPolicies": "se-",
      "serviceFabricClusters": "sf-",
      "signalRServiceSignalR": "sigr-",
      "sqlManagedInstances": "sqlmi-",
      "sqlServers": "sql-",
      "sqlServersDataWarehouse": "sqldw-",
      "sqlServersDatabase": "sqldb-",
      "sqlServersFirewallRules": "sqlfw-",
      "storageStorageAccounts": "st-",
      "storageStorageAccountsVm": "stvm-",
      "streamAnalyticsCluster": "asa-",
      "synapseWorkspaces": "syn-",
      "synapseWorkspacesAnalyticsWorkspaces": "synw-",
      "synapseWorkspacesSqlPoolsDedicated": "syndp-",
      "synapseWorkspacesSqlPoolsSpark": "synsp-",
      "timeSeriesInsightsEnvironments": "tsi-",
      "webContainerApps": "ca-",
      "webHostingEnvironments": "ase-",
      "webServerFarms": "plan-",
      "webSitesAppService": "app-",
      "webSitesAppServiceEnvironment": "ase-",
      "webSitesFunctions": "func-",
      "webStaticSites": "stapp-"
    },
    "shouldProvisionNewAI": "[equals(parameters('aSetupChoice'), 'new')]",
    "shouldUseExistingAI": "[and(equals(parameters('aSetupChoice'), 'existing'), not(empty(parameters('bFoundryEndpoint'))))]",
    "aiAccountName": "[if(variables('shouldUseExistingAI'), split(split(parameters('bFoundryEndpoint'), '://')[1], '.')[0], '')]",
    "computedAIResourceId": "[if(variables('shouldUseExistingAI'), format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.CognitiveServices/accounts/{2}', parameters('existingAISubscriptionId'), parameters('existingAIResourceGroupName'), variables('aiAccountName')), '')]",
    "effectiveChatModelName": "[if(not(empty(parameters('cChatModelName'))), parameters('cChatModelName'), if(variables('shouldProvisionNewAI'), parameters('chatModelName'), 'gpt-4o-mini'))]",
    "effectiveAudioModelName": "[if(not(empty(parameters('dAudioModelName'))), parameters('dAudioModelName'), 'gpt-4o-mini-audio-preview')]",
    "shouldEnableAI": "[or(variables('shouldProvisionNewAI'), variables('shouldUseExistingAI'))]",
    "shouldEnableAppInsights": "[parameters('enableApplicationInsights')]",
    "runnerPrincipalType": "[if(parameters('templateValidationMode'), 'ServicePrincipal', 'User')]",
    "abbrs": "[variables('$fxv#0')]",
    "resourceToken": "[if(parameters('templateValidationMode'), toLower(uniqueString(resourceGroup().id, parameters('environmentName'), parameters('location'), parameters('seed'))), toLower(uniqueString(resourceGroup().id, parameters('environmentName'), parameters('location'))))]",
    "tags": {
      "azd-env-name": "[parameters('environmentName')]"
    },
    "effectiveChatDeploymentName": "[variables('effectiveChatModelName')]",
    "aiChatModel": [
      {
        "name": "[variables('effectiveChatDeploymentName')]",
        "model": {
          "format": "[parameters('chatModelFormat')]",
          "name": "[parameters('chatModelName')]",
          "version": "[parameters('chatModelVersion')]"
        },
        "sku": {
          "name": "[parameters('chatDeploymentSku')]",
          "capacity": "[parameters('chatDeploymentCapacity')]"
        }
      }
    ],
    "aiDeployments": "[variables('aiChatModel')]"
  },
  "resources": [
    {
      "condition": "[variables('shouldProvisionNewAI')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "ai",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "aiProjectName": "[if(not(empty(parameters('aiProjectName'))), createObject('value', parameters('aiProjectName')), createObject('value', format('{0}-aiproject', parameters('environmentName'))))]",
          "aiServicesName": "[if(not(empty(parameters('aiServicesName'))), createObject('value', parameters('aiServicesName')), createObject('value', format('{0}-ai', parameters('environmentName'))))]",
          "storageAccountName": "[if(not(empty(parameters('storageAccountName'))), createObject('value', parameters('storageAccountName')), createObject('value', format('{0}st', replace(parameters('environmentName'), '-', ''))))]",
          "aiServiceModelDeployments": {
            "value": "[variables('aiDeployments')]"
          },
          "appInsightConnectionName": {
            "value": "appinsight-connection"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "17005866665169169570"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "minLength": 1,
              "metadata": {
                "description": "Primary location for all resources"
              }
            },
            "aiProjectName": {
              "type": "string",
              "metadata": {
                "description": "The AI Project resource name."
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "The Storage Account resource name."
              }
            },
            "aiServicesName": {
              "type": "string",
              "metadata": {
                "description": "The AI Services resource name."
              }
            },
            "aiServiceModelDeployments": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The AI Services model deployments."
              }
            },
            "appInsightConnectionName": {
              "type": "string",
              "metadata": {
                "description": "The Application Insights connection name."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "storageAccount",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "name": {
                    "value": "[parameters('storageAccountName')]"
                  },
                  "containers": {
                    "value": [
                      {
                        "name": "default"
                      }
                    ]
                  },
                  "files": {
                    "value": [
                      {
                        "name": "default"
                      }
                    ]
                  },
                  "queues": {
                    "value": [
                      {
                        "name": "default"
                      }
                    ]
                  },
                  "tables": {
                    "value": [
                      {
                        "name": "default"
                      }
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "10717111524645732551"
                    },
                    "description": "Creates an Azure storage account."
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "accessTier": {
                      "type": "string",
                      "defaultValue": "Hot",
                      "allowedValues": [
                        "Cool",
                        "Hot",
                        "Premium"
                      ]
                    },
                    "allowBlobPublicAccess": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "allowCrossTenantReplication": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "allowSharedKeyAccess": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "containers": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "corsRules": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "defaultToOAuthAuthentication": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "deleteRetentionPolicy": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "dnsEndpointType": {
                      "type": "string",
                      "defaultValue": "Standard",
                      "allowedValues": [
                        "AzureDnsZone",
                        "Standard"
                      ]
                    },
                    "files": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "kind": {
                      "type": "string",
                      "defaultValue": "StorageV2"
                    },
                    "minimumTlsVersion": {
                      "type": "string",
                      "defaultValue": "TLS1_2"
                    },
                    "queues": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "shareDeleteRetentionPolicy": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "supportsHttpsTrafficOnly": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "tables": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "networkAcls": {
                      "type": "object",
                      "defaultValue": {
                        "bypass": "AzureServices",
                        "defaultAction": "Allow"
                      }
                    },
                    "publicNetworkAccess": {
                      "type": "string",
                      "defaultValue": "Enabled",
                      "allowedValues": [
                        "Enabled",
                        "Disabled"
                      ]
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "storage::blobServices::container",
                        "count": "[length(parameters('containers'))]"
                      },
                      "condition": "[not(empty(parameters('containers')))]",
                      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                      "apiVersion": "2023-01-01",
                      "name": "[format('{0}/{1}/{2}', parameters('name'), 'default', parameters('containers')[copyIndex()].name)]",
                      "properties": {
                        "publicAccess": "[coalesce(tryGet(parameters('containers')[copyIndex()], 'publicAccess'), 'None')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('name'), 'default')]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "storage::queueServices::queue",
                        "count": "[length(parameters('queues'))]"
                      },
                      "condition": "[not(empty(parameters('queues')))]",
                      "type": "Microsoft.Storage/storageAccounts/queueServices/queues",
                      "apiVersion": "2023-01-01",
                      "name": "[format('{0}/{1}/{2}', parameters('name'), 'default', parameters('queues')[copyIndex()].name)]",
                      "properties": {
                        "metadata": {}
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts/queueServices', parameters('name'), 'default')]"
                      ]
                    },
                    {
                      "condition": "[not(empty(parameters('containers')))]",
                      "type": "Microsoft.Storage/storageAccounts/blobServices",
                      "apiVersion": "2023-01-01",
                      "name": "[format('{0}/{1}', parameters('name'), 'default')]",
                      "properties": {
                        "cors": {
                          "corsRules": "[parameters('corsRules')]"
                        },
                        "deleteRetentionPolicy": "[parameters('deleteRetentionPolicy')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
                      ]
                    },
                    {
                      "condition": "[not(empty(parameters('files')))]",
                      "type": "Microsoft.Storage/storageAccounts/fileServices",
                      "apiVersion": "2023-01-01",
                      "name": "[format('{0}/{1}', parameters('name'), 'default')]",
                      "properties": {
                        "cors": {
                          "corsRules": "[parameters('corsRules')]"
                        },
                        "shareDeleteRetentionPolicy": "[parameters('shareDeleteRetentionPolicy')]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
                      ]
                    },
                    {
                      "condition": "[not(empty(parameters('queues')))]",
                      "type": "Microsoft.Storage/storageAccounts/queueServices",
                      "apiVersion": "2023-01-01",
                      "name": "[format('{0}/{1}', parameters('name'), 'default')]",
                      "properties": {},
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
                      ]
                    },
                    {
                      "condition": "[not(empty(parameters('tables')))]",
                      "type": "Microsoft.Storage/storageAccounts/tableServices",
                      "apiVersion": "2023-01-01",
                      "name": "[format('{0}/{1}', parameters('name'), 'default')]",
                      "properties": {},
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2023-01-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "kind": "[parameters('kind')]",
                      "sku": {
                        "name": "Standard_LRS"
                      },
                      "properties": {
                        "accessTier": "[parameters('accessTier')]",
                        "allowBlobPublicAccess": "[parameters('allowBlobPublicAccess')]",
                        "allowCrossTenantReplication": "[parameters('allowCrossTenantReplication')]",
                        "allowSharedKeyAccess": "[parameters('allowSharedKeyAccess')]",
                        "defaultToOAuthAuthentication": "[parameters('defaultToOAuthAuthentication')]",
                        "dnsEndpointType": "[parameters('dnsEndpointType')]",
                        "minimumTlsVersion": "[parameters('minimumTlsVersion')]",
                        "networkAcls": "[parameters('networkAcls')]",
                        "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                        "supportsHttpsTrafficOnly": "[parameters('supportsHttpsTrafficOnly')]"
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "primaryEndpoints": {
                      "type": "object",
                      "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2023-01-01').primaryEndpoints]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "aiServices",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "aiServiceName": {
                    "value": "[parameters('aiServicesName')]"
                  },
                  "aiProjectName": {
                    "value": "[parameters('aiProjectName')]"
                  },
                  "deployments": {
                    "value": "[parameters('aiServiceModelDeployments')]"
                  },
                  "appInsightsId": {
                    "value": ""
                  },
                  "appInsightConnectionString": {
                    "value": ""
                  },
                  "appInsightConnectionName": {
                    "value": "[parameters('appInsightConnectionName')]"
                  },
                  "storageAccountId": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageAccount'), '2025-04-01').outputs.id.value]"
                  },
                  "storageAccountConnectionName": {
                    "value": "storage-connection"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "5052516130956844926"
                    },
                    "description": "Creates an Azure Cognitive Services instance."
                  },
                  "parameters": {
                    "aiServiceName": {
                      "type": "string"
                    },
                    "aiProjectName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "customSubDomainName": {
                      "type": "string",
                      "defaultValue": "[parameters('aiServiceName')]",
                      "metadata": {
                        "description": "The custom subdomain name used to access the API. Defaults to the value of the name parameter."
                      }
                    },
                    "disableLocalAuth": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "deployments": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "appInsightsId": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "appInsightConnectionString": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "appInsightConnectionName": {
                      "type": "string"
                    },
                    "storageAccountId": {
                      "type": "string"
                    },
                    "storageAccountConnectionName": {
                      "type": "string"
                    },
                    "publicNetworkAccess": {
                      "type": "string",
                      "defaultValue": "Enabled",
                      "allowedValues": [
                        "Enabled",
                        "Disabled"
                      ]
                    },
                    "sku": {
                      "type": "object",
                      "defaultValue": {
                        "name": "S0"
                      }
                    },
                    "allowedIpRules": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "networkAcls": {
                      "type": "object",
                      "defaultValue": "[if(empty(parameters('allowedIpRules')), createObject('defaultAction', 'Allow'), createObject('ipRules', parameters('allowedIpRules'), 'defaultAction', 'Deny'))]"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.CognitiveServices/accounts",
                      "apiVersion": "2023-10-01-preview",
                      "name": "[parameters('aiServiceName')]",
                      "location": "[parameters('location')]",
                      "sku": "[parameters('sku')]",
                      "kind": "AIServices",
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "customSubDomainName": "[parameters('customSubDomainName')]",
                        "networkAcls": "[parameters('networkAcls')]",
                        "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                        "disableLocalAuth": "[parameters('disableLocalAuth')]"
                      }
                    },
                    {
                      "condition": "[not(empty(parameters('appInsightsId')))]",
                      "type": "Microsoft.CognitiveServices/accounts/connections",
                      "apiVersion": "2023-10-01-preview",
                      "name": "[format('{0}/{1}', parameters('aiServiceName'), parameters('appInsightConnectionName'))]",
                      "properties": {
                        "category": "AppInsights",
                        "target": "[parameters('appInsightsId')]",
                        "authType": "ApiKey",
                        "isSharedToAll": true,
                        "credentials": {
                          "key": "[parameters('appInsightConnectionString')]"
                        },
                        "metadata": {
                          "ApiType": "Azure",
                          "ResourceId": "[parameters('appInsightsId')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServiceName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.CognitiveServices/accounts/connections",
                      "apiVersion": "2023-10-01-preview",
                      "name": "[format('{0}/{1}', parameters('aiServiceName'), parameters('storageAccountConnectionName'))]",
                      "properties": {
                        "category": "AzureStorageAccount",
                        "target": "[parameters('storageAccountId')]",
                        "authType": "AAD",
                        "isSharedToAll": true,
                        "metadata": {
                          "ApiType": "Azure",
                          "ResourceId": "[parameters('storageAccountId')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServiceName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.CognitiveServices/accounts/projects",
                      "apiVersion": "2023-10-01-preview",
                      "name": "[format('{0}/{1}', parameters('aiServiceName'), parameters('aiProjectName'))]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {
                        "description": "AI Project for TechMart Chatbot",
                        "displayName": "TechMart AI Project"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServiceName'))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "aiServicesDeployments",
                        "count": "[length(parameters('deployments'))]",
                        "mode": "serial",
                        "batchSize": 1
                      },
                      "type": "Microsoft.CognitiveServices/accounts/deployments",
                      "apiVersion": "2023-10-01-preview",
                      "name": "[format('{0}/{1}', parameters('aiServiceName'), parameters('deployments')[copyIndex()].name)]",
                      "properties": {
                        "model": "[parameters('deployments')[copyIndex()].model]",
                        "raiPolicyName": "[tryGet(parameters('deployments')[copyIndex()], 'raiPolicyName')]"
                      },
                      "sku": "[parameters('deployments')[copyIndex()].sku]",
                      "dependsOn": [
                        "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServiceName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServiceName'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('aiServiceName')]"
                    },
                    "endpoint": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServiceName')), '2023-10-01-preview').endpoint]"
                    },
                    "projectId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('aiServiceName'), parameters('aiProjectName'))]"
                    },
                    "projectEndpoint": {
                      "type": "string",
                      "value": "[format('https://{0}/api/projects/{1}', reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServiceName')), '2023-10-01-preview').endpoint, parameters('aiProjectName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'storageAccount')]"
              ]
            }
          ],
          "outputs": {
            "projectId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'aiServices'), '2025-04-01').outputs.projectId.value]"
            },
            "projectEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'aiServices'), '2025-04-01').outputs.projectEndpoint.value]"
            },
            "storageAccountId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageAccount'), '2025-04-01').outputs.id.value]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appserviceplan",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": "[if(not(empty(parameters('appServicePlanName'))), createObject('value', parameters('appServicePlanName')), createObject('value', format('{0}-asplan', parameters('environmentName'))))]",
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "sku": {
            "value": {
              "name": "B2",
              "capacity": 1
            }
          },
          "kind": {
            "value": "linux"
          },
          "reserved": {
            "value": true
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "9410530852624477624"
            },
            "description": "Creates an Azure App Service Plan"
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "sku": {
              "type": "object",
              "defaultValue": {
                "name": "B1",
                "capacity": 1
              },
              "metadata": {
                "description": "The pricing tier for the hosting plan."
              }
            },
            "kind": {
              "type": "string",
              "defaultValue": "linux",
              "allowedValues": [
                "windows",
                "linux"
              ],
              "metadata": {
                "description": "The operating system the app service plan should target."
              }
            },
            "reserved": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "True if the App Service Plan should be reserved (Linux), false otherwise."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2022-09-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": "[parameters('sku')]",
              "kind": "[parameters('kind')]",
              "properties": {
                "reserved": "[parameters('reserved')]"
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "api",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}app', replace(parameters('environmentName'), '-', ''))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[union(variables('tags'), createObject('azd-service-name', 'api'))]"
          },
          "identityName": "[if(parameters('enableManagedIdentity'), createObject('value', format('{0}-mi', parameters('environmentName'))), createObject('value', ''))]",
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appserviceplan'), '2025-04-01').outputs.id.value]"
          },
          "enableAIServices": {
            "value": "[variables('shouldEnableAI')]"
          },
          "enableManagedIdentity": {
            "value": "[parameters('enableManagedIdentity')]"
          },
          "azureExistingAIProjectResourceId": {
            "value": "[variables('computedAIResourceId')]"
          },
          "aiFoundryEndpoint": {
            "value": "[parameters('bFoundryEndpoint')]"
          },
          "chatDeploymentName": {
            "value": "[variables('effectiveChatDeploymentName')]"
          },
          "audioDeploymentName": {
            "value": "[variables('effectiveAudioModelName')]"
          },
          "enableAzureMonitorTracing": {
            "value": "[parameters('enableAzureMonitorTracing')]"
          },
          "azureTracingGenAIContentRecordingEnabled": {
            "value": "[parameters('azureTracingGenAIContentRecordingEnabled')]"
          },
          "projectEndpoint": {
            "value": ""
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "5516789162284352705"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "appServicePlanId": {
              "type": "string"
            },
            "enableManagedIdentity": {
              "type": "bool",
              "defaultValue": false
            },
            "enableAIServices": {
              "type": "bool",
              "defaultValue": false
            },
            "identityName": {
              "type": "string",
              "defaultValue": ""
            },
            "azureExistingAIProjectResourceId": {
              "type": "string",
              "defaultValue": ""
            },
            "aiFoundryEndpoint": {
              "type": "string",
              "defaultValue": ""
            },
            "chatDeploymentName": {
              "type": "string",
              "defaultValue": ""
            },
            "audioDeploymentName": {
              "type": "string",
              "defaultValue": ""
            },
            "enableAzureMonitorTracing": {
              "type": "bool",
              "defaultValue": false
            },
            "azureTracingGenAIContentRecordingEnabled": {
              "type": "bool",
              "defaultValue": false
            },
            "projectEndpoint": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "variables": {
            "baseEnv": [
              {
                "name": "FLASK_APP",
                "value": "app.py"
              },
              {
                "name": "FLASK_ENV",
                "value": "production"
              },
              {
                "name": "PYTHONUNBUFFERED",
                "value": "1"
              },
              {
                "name": "WEBSITE_WEBDEPLOY_USE_SCM",
                "value": "true"
              },
              {
                "name": "PYTHONPATH",
                "value": "/home/site/wwwroot"
              },
              {
                "name": "WEBSITES_ENABLE_APP_SERVICE_STORAGE",
                "value": "false"
              },
              {
                "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
                "value": "true"
              },
              {
                "name": "ENABLE_ORYX_BUILD",
                "value": "true"
              }
            ],
            "infrastructureEnv": [],
            "hasAIConfig": "[or(parameters('enableAIServices'), or(not(empty(parameters('aiFoundryEndpoint'))), not(empty(parameters('chatDeploymentName')))))]",
            "aiEnv": "[if(variables('hasAIConfig'), createArray(createObject('name', 'AZURE_EXISTING_AIPROJECT_RESOURCE_ID', 'value', parameters('azureExistingAIProjectResourceId')), createObject('name', 'EXISTING_AI_FOUNDRY_ENDPOINT', 'value', parameters('aiFoundryEndpoint')), createObject('name', 'AZURE_INFERENCE_ENDPOINT', 'value', parameters('aiFoundryEndpoint')), createObject('name', 'AZURE_CLIENT_ID', 'value', 'system-assigned-managed-identity'), createObject('name', 'AZURE_AI_CHAT_DEPLOYMENT_NAME', 'value', parameters('chatDeploymentName')), createObject('name', 'AZURE_AI_AUDIO_DEPLOYMENT_NAME', 'value', parameters('audioDeploymentName')), createObject('name', 'ENABLE_AZURE_MONITOR_TRACING', 'value', string(parameters('enableAzureMonitorTracing'))), createObject('name', 'AZURE_TRACING_GEN_AI_CONTENT_RECORDING_ENABLED', 'value', string(parameters('azureTracingGenAIContentRecordingEnabled'))), createObject('name', 'AZURE_EXISTING_AIPROJECT_ENDPOINT', 'value', parameters('projectEndpoint'))), createArray())]",
            "env": "[concat(concat(variables('baseEnv'), variables('aiEnv')), variables('infrastructureEnv'))]",
            "appSettings": "[reduce(variables('env'), createObject(), lambda('acc', 'curr', union(lambdaVariables('acc'), createObject(format('{0}', lambdaVariables('curr').name), lambdaVariables('curr').value))))]"
          },
          "resources": [
            {
              "condition": "[parameters('enableManagedIdentity')]",
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('identityName')]",
              "location": "[parameters('location')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "appservice",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('name')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "appServicePlanId": {
                    "value": "[parameters('appServicePlanId')]"
                  },
                  "runtimeName": {
                    "value": "python"
                  },
                  "runtimeVersion": {
                    "value": "3.11"
                  },
                  "appCommandLine": {
                    "value": "gunicorn --bind=0.0.0.0:8000 --workers=1 --timeout=600 --preload wsgi:app"
                  },
                  "managedIdentity": {
                    "value": "[parameters('enableManagedIdentity')]"
                  },
                  "allowedOrigins": {
                    "value": [
                      "https://portal.azure.com",
                      "https://ms.portal.azure.com",
                      "https://ai.azure.com"
                    ]
                  },
                  "appSettings": {
                    "value": "[variables('appSettings')]"
                  },
                  "scmDoBuildDuringDeployment": {
                    "value": true
                  },
                  "enableOryxBuild": {
                    "value": true
                  },
                  "linuxFxVersion": {
                    "value": "PYTHON|3.11"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.38.33.27573",
                      "templateHash": "13421784193254680722"
                    },
                    "description": "Creates an Azure App Service in an existing Azure App Service plan."
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "appServicePlanId": {
                      "type": "string"
                    },
                    "managedIdentity": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "runtimeName": {
                      "type": "string",
                      "allowedValues": [
                        "dotnet",
                        "dotnetcore",
                        "dotnet-isolated",
                        "node",
                        "python",
                        "java",
                        "powershell",
                        "custom"
                      ]
                    },
                    "runtimeNameAndVersion": {
                      "type": "string",
                      "defaultValue": "[format('{0}|{1}', parameters('runtimeName'), parameters('runtimeVersion'))]"
                    },
                    "runtimeVersion": {
                      "type": "string"
                    },
                    "kind": {
                      "type": "string",
                      "defaultValue": "app,linux"
                    },
                    "allowedOrigins": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "alwaysOn": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "appCommandLine": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "appSettings": {
                      "type": "secureObject",
                      "defaultValue": {}
                    },
                    "clientAffinityEnabled": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "enableOryxBuild": {
                      "type": "bool",
                      "defaultValue": "[contains(parameters('kind'), 'linux')]"
                    },
                    "functionAppScaleLimit": {
                      "type": "int",
                      "defaultValue": -1
                    },
                    "linuxFxVersion": {
                      "type": "string",
                      "defaultValue": "[parameters('runtimeNameAndVersion')]"
                    },
                    "minimumElasticInstanceCount": {
                      "type": "int",
                      "defaultValue": -1
                    },
                    "numberOfWorkers": {
                      "type": "int",
                      "defaultValue": -1
                    },
                    "scmDoBuildDuringDeployment": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "use32BitWorkerProcess": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "ftpsState": {
                      "type": "string",
                      "defaultValue": "FtpsOnly"
                    },
                    "healthCheckPath": {
                      "type": "string",
                      "defaultValue": ""
                    }
                  },
                  "variables": {
                    "baseAppSettings": "[union(parameters('appSettings'), createObject('SCM_DO_BUILD_DURING_DEPLOYMENT', string(parameters('scmDoBuildDuringDeployment')), 'ENABLE_ORYX_BUILD', string(parameters('enableOryxBuild'))))]",
                    "pythonAppSettings": "[if(and(equals(parameters('runtimeName'), 'python'), equals(parameters('appCommandLine'), '')), createObject('PYTHON_ENABLE_GUNICORN_MULTIWORKERS', 'true'), createObject())]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Web/sites/basicPublishingCredentialsPolicies",
                      "apiVersion": "2022-09-01",
                      "name": "[format('{0}/{1}', parameters('name'), 'ftp')]",
                      "properties": {
                        "allow": false
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Web/sites', parameters('name'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Web/sites/basicPublishingCredentialsPolicies",
                      "apiVersion": "2022-09-01",
                      "name": "[format('{0}/{1}', parameters('name'), 'scm')]",
                      "properties": {
                        "allow": false
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Web/sites', parameters('name'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Web/sites",
                      "apiVersion": "2022-09-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "kind": "[parameters('kind')]",
                      "properties": {
                        "serverFarmId": "[parameters('appServicePlanId')]",
                        "siteConfig": {
                          "linuxFxVersion": "[parameters('linuxFxVersion')]",
                          "alwaysOn": "[parameters('alwaysOn')]",
                          "ftpsState": "[parameters('ftpsState')]",
                          "minTlsVersion": "1.2",
                          "appCommandLine": "[parameters('appCommandLine')]",
                          "numberOfWorkers": "[if(not(equals(parameters('numberOfWorkers'), -1)), parameters('numberOfWorkers'), null())]",
                          "minimumElasticInstanceCount": "[if(not(equals(parameters('minimumElasticInstanceCount'), -1)), parameters('minimumElasticInstanceCount'), null())]",
                          "use32BitWorkerProcess": "[parameters('use32BitWorkerProcess')]",
                          "functionAppScaleLimit": "[if(not(equals(parameters('functionAppScaleLimit'), -1)), parameters('functionAppScaleLimit'), null())]",
                          "healthCheckPath": "[parameters('healthCheckPath')]",
                          "cors": {
                            "allowedOrigins": "[union(createArray('https://portal.azure.com', 'https://ms.portal.azure.com'), parameters('allowedOrigins'))]"
                          }
                        },
                        "clientAffinityEnabled": "[parameters('clientAffinityEnabled')]",
                        "httpsOnly": true
                      },
                      "identity": {
                        "type": "[if(parameters('managedIdentity'), 'SystemAssigned', 'None')]"
                      }
                    },
                    {
                      "type": "Microsoft.Web/sites/config",
                      "apiVersion": "2022-09-01",
                      "name": "[format('{0}/{1}', parameters('name'), 'logs')]",
                      "properties": {
                        "applicationLogs": {
                          "fileSystem": {
                            "level": "Verbose"
                          }
                        },
                        "detailedErrorMessages": {
                          "enabled": true
                        },
                        "failedRequestsTracing": {
                          "enabled": true
                        },
                        "httpLogs": {
                          "fileSystem": {
                            "enabled": true,
                            "retentionInDays": 1,
                            "retentionInMb": 35
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Web/sites', parameters('name'))]",
                        "[resourceId('Microsoft.Resources/deployments', format('{0}-appSettings', parameters('name')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2025-04-01",
                      "name": "[format('{0}-appSettings', parameters('name'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "name": {
                            "value": "[parameters('name')]"
                          },
                          "appSettings": {
                            "value": "[union(variables('baseAppSettings'), variables('pythonAppSettings'))]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.38.33.27573",
                              "templateHash": "16818702544742325324"
                            },
                            "description": "Updates app settings for an Azure App Service."
                          },
                          "parameters": {
                            "name": {
                              "type": "string",
                              "metadata": {
                                "description": "The name of the app service resource within the current resource group scope"
                              }
                            },
                            "appSettings": {
                              "type": "secureObject",
                              "metadata": {
                                "description": "The app settings to be applied to the app service"
                              }
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Web/sites/config",
                              "apiVersion": "2022-09-01",
                              "name": "[format('{0}/{1}', parameters('name'), 'appsettings')]",
                              "properties": "[parameters('appSettings')]"
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Web/sites', parameters('name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "identityPrincipalId": {
                      "type": "string",
                      "value": "[if(parameters('managedIdentity'), reference(resourceId('Microsoft.Web/sites', parameters('name')), '2022-09-01', 'full').identity.principalId, '')]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "uri": {
                      "type": "string",
                      "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('name')), '2022-09-01').defaultHostName)]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "DEBUG_API": {
              "type": "object",
              "value": {
                "enableManagedIdentity": "[parameters('enableManagedIdentity')]",
                "identityPrincipalIdLength": "[if(parameters('enableManagedIdentity'), length(reference(resourceId('Microsoft.Resources/deployments', 'appservice'), '2025-04-01').outputs.identityPrincipalId.value), 0)]",
                "enableAIServices": "[parameters('enableAIServices')]",
                "hasAIConfig": "[variables('hasAIConfig')]",
                "aiFoundryEndpoint": "[parameters('aiFoundryEndpoint')]",
                "chatDeploymentName": "[parameters('chatDeploymentName')]",
                "audioDeploymentName": "[parameters('audioDeploymentName')]"
              }
            },
            "SERVICE_API_IDENTITY_PRINCIPAL_ID": {
              "type": "string",
              "value": "[if(parameters('enableManagedIdentity'), reference(resourceId('Microsoft.Resources/deployments', 'appservice'), '2025-04-01').outputs.identityPrincipalId.value, '')]"
            },
            "SERVICE_API_NAME": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appservice'), '2025-04-01').outputs.name.value]"
            },
            "SERVICE_API_URI": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appservice'), '2025-04-01').outputs.uri.value]"
            },
            "SERVICE_API_ENDPOINTS": {
              "type": "array",
              "value": [
                "[reference(resourceId('Microsoft.Resources/deployments', 'appservice'), '2025-04-01').outputs.uri.value]"
              ]
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appserviceplan')]"
      ]
    },
    {
      "condition": "[and(variables('shouldEnableAI'), not(empty(parameters('principalId'))))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "user-role-azureai-developer",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalType": {
            "value": "[variables('runnerPrincipalType')]"
          },
          "principalId": {
            "value": "[parameters('principalId')]"
          },
          "roleDefinitionId": {
            "value": "64702f94-c441-49e6-a78b-ef80e0188fee"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1371346527966686653"
            },
            "description": "Creates a role assignment for a given principal and role definition."
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID to assign the role to"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "The role definition ID to assign"
              }
            },
            "principalType": {
              "type": "string",
              "metadata": {
                "description": "The type of principal (User, ServicePrincipal, Group, etc.)"
              }
            },
            "resourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource ID to assign the role to. If not provided, the assignment will be at the current scope."
              }
            }
          },
          "variables": {
            "roleAssignmentName": "[guid(parameters('principalId'), parameters('roleDefinitionId'), parameters('resourceId'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[variables('roleAssignmentName')]",
              "properties": {
                "principalId": "[parameters('principalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalType": "[parameters('principalType')]"
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Authorization/roleAssignments', variables('roleAssignmentName'))]"
            }
          }
        }
      }
    },
    {
      "condition": "[and(variables('shouldProvisionNewAI'), parameters('enableManagedIdentity'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "api-role-azureai-developer",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalType": {
            "value": "ServicePrincipal"
          },
          "principalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'api'), '2025-04-01').outputs.SERVICE_API_IDENTITY_PRINCIPAL_ID.value]"
          },
          "roleDefinitionId": {
            "value": "64702f94-c441-49e6-a78b-ef80e0188fee"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1371346527966686653"
            },
            "description": "Creates a role assignment for a given principal and role definition."
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID to assign the role to"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "The role definition ID to assign"
              }
            },
            "principalType": {
              "type": "string",
              "metadata": {
                "description": "The type of principal (User, ServicePrincipal, Group, etc.)"
              }
            },
            "resourceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource ID to assign the role to. If not provided, the assignment will be at the current scope."
              }
            }
          },
          "variables": {
            "roleAssignmentName": "[guid(parameters('principalId'), parameters('roleDefinitionId'), parameters('resourceId'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[variables('roleAssignmentName')]",
              "properties": {
                "principalId": "[parameters('principalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalType": "[parameters('principalType')]"
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Authorization/roleAssignments', variables('roleAssignmentName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'api')]"
      ]
    },
    {
      "condition": "[and(variables('shouldUseExistingAI'), parameters('enableManagedIdentity'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "existing-ai-rbac-instructions",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiFoundryResourceId": {
            "value": "[variables('computedAIResourceId')]"
          },
          "appServicePrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'api'), '2025-04-01').outputs.SERVICE_API_IDENTITY_PRINCIPAL_ID.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "4535156078739811206"
            },
            "description": "Note: This module is a placeholder. RBAC for existing AI Foundry resources should be configured manually or through the Azure portal/CLI after deployment."
          },
          "parameters": {
            "aiFoundryResourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the existing Azure AI Foundry service"
              }
            },
            "appServicePrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the App Service Managed Identity"
              }
            }
          },
          "resources": [],
          "outputs": {
            "aiFoundryResourceId": {
              "type": "string",
              "value": "[parameters('aiFoundryResourceId')]"
            },
            "appServicePrincipalId": {
              "type": "string",
              "value": "[parameters('appServicePrincipalId')]"
            },
            "instructions": {
              "type": "string",
              "value": "[format('Run: az role assignment create --role \"Cognitive Services OpenAI User\" --assignee {0} --scope {1}', parameters('appServicePrincipalId'), parameters('aiFoundryResourceId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'api')]"
      ]
    }
  ],
  "outputs": {
    "DEBUG_PARAMETERS": {
      "type": "object",
      "value": {
        "enableManagedIdentity": "[parameters('enableManagedIdentity')]",
        "principalIdProvided": "[not(empty(parameters('principalId')))]",
        "principalIdLength": "[length(parameters('principalId'))]",
        "externalAzureAIEndpointProvided": "[not(empty(parameters('externalAzureAIEndpoint')))]"
      }
    },
    "DEBUG_RESOURCE_NAMES": {
      "type": "object",
      "value": {
        "environmentName": "[parameters('environmentName')]",
        "resourceToken": "[variables('resourceToken')]",
        "appServiceName": "[format('{0}app', replace(parameters('environmentName'), '-', ''))]",
        "appServicePlanName": "[if(not(empty(parameters('appServicePlanName'))), parameters('appServicePlanName'), format('{0}-asplan', parameters('environmentName')))]",
        "managedIdentityName": "[if(parameters('enableManagedIdentity'), format('{0}-mi', parameters('environmentName')), '')]",
        "aiProjectName": "[if(not(empty(parameters('aiProjectName'))), parameters('aiProjectName'), format('{0}{1}', variables('abbrs').machineLearningServicesWorkspaces, variables('resourceToken')))]",
        "aiServicesName": "[if(not(empty(parameters('aiServicesName'))), parameters('aiServicesName'), format('{0}{1}', variables('abbrs').cognitiveServicesAccounts, variables('resourceToken')))]",
        "storageAccountName": "[if(not(empty(parameters('storageAccountName'))), parameters('storageAccountName'), format('{0}{1}', variables('abbrs').storageStorageAccounts, variables('resourceToken')))]"
      }
    },
    "DEBUG_AI_FOUNDRY_DEPLOYMENT": {
      "type": "object",
      "value": {
        "aiFoundryMode": "[parameters('aSetupChoice')]",
        "shouldProvisionNewAI": "[variables('shouldProvisionNewAI')]",
        "shouldUseExistingAI": "[variables('shouldUseExistingAI')]",
        "existingEndpoint": "[parameters('bFoundryEndpoint')]",
        "existingResourceId": "[variables('computedAIResourceId')]",
        "configurationMethod": "environment-variables",
        "rbacInstructions": "[if(variables('shouldUseExistingAI'), 'Check existingAIRbacInstructions module output', 'Auto-configured for new AI services')]"
      }
    },
    "AZURE_LOCATION": {
      "type": "string",
      "value": "[parameters('location')]"
    },
    "AZURE_RESOURCE_GROUP": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "AZURE_TENANT_ID": {
      "type": "string",
      "value": "[tenant().tenantId]"
    },
    "AZURE_EXISTING_AIPROJECT_RESOURCE_ID": {
      "type": "string",
      "value": "[variables('computedAIResourceId')]"
    },
    "AZURE_AI_CHAT_DEPLOYMENT_NAME": {
      "type": "string",
      "value": "[if(variables('shouldEnableAI'), variables('effectiveChatDeploymentName'), '')]"
    },
    "AZURE_AI_SEARCH_ENDPOINT": {
      "type": "string",
      "value": ""
    },
    "AZURE_EXISTING_AIPROJECT_ENDPOINT": {
      "type": "string",
      "value": ""
    },
    "ENABLE_AZURE_MONITOR_TRACING": {
      "type": "bool",
      "value": "[if(variables('shouldEnableAppInsights'), parameters('enableAzureMonitorTracing'), false())]"
    },
    "AZURE_TRACING_GEN_AI_CONTENT_RECORDING_ENABLED": {
      "type": "bool",
      "value": "[if(variables('shouldEnableAppInsights'), parameters('azureTracingGenAIContentRecordingEnabled'), false())]"
    },
    "SERVICE_API_IDENTITY_PRINCIPAL_ID": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'api'), '2025-04-01').outputs.SERVICE_API_IDENTITY_PRINCIPAL_ID.value]"
    },
    "SERVICE_API_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'api'), '2025-04-01').outputs.SERVICE_API_NAME.value]"
    },
    "SERVICE_API_URI": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'api'), '2025-04-01').outputs.SERVICE_API_URI.value]"
    },
    "SERVICE_API_ENDPOINTS": {
      "type": "array",
      "value": [
        "[format('{0}', reference(resourceId('Microsoft.Resources/deployments', 'api'), '2025-04-01').outputs.SERVICE_API_URI.value)]"
      ]
    }
  }
}