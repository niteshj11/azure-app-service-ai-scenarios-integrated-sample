# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: azure-app-service-ai-scenarios
metadata:
  template: azure-app-service-ai-scenarios@1.0.0
  description: "Comprehensive Azure App Service AI scenarios with Azure AI Foundry integration"

services:
  api:
    host: appservice
    project: ./
    language: python

infra:
  provider: bicep
  path: infra

hooks:
  preprovision:
    shell: pwsh
    interactive: true
    run: |
      Write-Host "" -ForegroundColor Cyan
      Write-Host "=== DEBUG: PREPROVISION HOOK START ===" -ForegroundColor Cyan
      Write-Host "Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
      Write-Host "" -ForegroundColor Cyan
      
      # Set up principal ID for RBAC (required for role assignments)
      Write-Host "üîê Setting up principal ID for RBAC..." -ForegroundColor Cyan
      try {
          $currentUser = az ad signed-in-user show --query id --output tsv
          if ($currentUser) {
              azd env set principalId $currentUser
              Write-Host "‚úì Principal ID set: $currentUser" -ForegroundColor Green
          } else {
              Write-Host "‚ö†Ô∏è  Could not retrieve current user ID" -ForegroundColor Yellow
          }
      } catch {
          Write-Host "‚ö†Ô∏è  Error retrieving principal ID: $($_.Exception.Message)" -ForegroundColor Yellow
          Write-Host "   This can be set manually if needed" -ForegroundColor Gray
      }
      
      Write-Host "" -ForegroundColor Cyan
      Write-Host "ü§ñ DEBUG: Collecting AI Setup parameters..." -ForegroundColor Cyan
      Write-Host "Current environment variables:" -ForegroundColor Gray
      try {
          $envVars = @('aSetupChoice', 'bFoundryEndpoint', 'cChatModelName', 'dAudioModelName', 'eAISubscriptionId', 'fAIResourceGroup')
          foreach ($var in $envVars) {
              $value = azd env get-value $var 2>$null
              if ($LASTEXITCODE -eq 0 -and -not [string]::IsNullOrEmpty($value)) {
                  Write-Host "   $var = $value" -ForegroundColor Gray
              } else {
                  Write-Host "   $var = <not set>" -ForegroundColor DarkGray
              }
          }
      } catch {
          Write-Host "   Error reading environment variables: $($_.Exception.Message)" -ForegroundColor Yellow
      }
      Write-Host "" -ForegroundColor Cyan
      
      # Check if setup choice is already configured
      $setupChoice = $null
      $output = azd env get-value aSetupChoice 2>&1
      if ($LASTEXITCODE -eq 0 -and -not [string]::IsNullOrEmpty($output) -and -not $output.ToString().Contains("ERROR")) {
          $setupChoice = $output.ToString().Trim()
          Write-Host "‚úì DEBUG: Found existing setup choice: $setupChoice" -ForegroundColor Green
      } else {
          # Prompt for setup choice
          do {
              $setupChoice = Read-Host "üöÄ AI Setup: Choose new (create AI services) or existing (use your AI Foundry project) [new/existing]"
              if ($setupChoice) {
                  $setupChoice = $setupChoice.ToLower().Trim()
              }
              if ($setupChoice -ne "new" -and $setupChoice -ne "existing") {
                  Write-Host "Please enter either 'new' or 'existing'" -ForegroundColor Yellow
              }
          } while ([string]::IsNullOrEmpty($setupChoice) -or ($setupChoice -ne "new" -and $setupChoice -ne "existing"))
          
          azd env set aSetupChoice $setupChoice
          Write-Host "‚úì Set AI setup choice: $setupChoice" -ForegroundColor Green
      }
      
      if ($setupChoice -eq "existing") {
          # Collect existing AI Foundry details
          $foundryEndpoint = $null
          $chatModel = $null
          $audioModel = $null
          
          $output = azd env get-value bFoundryEndpoint 2>&1
          if ($LASTEXITCODE -eq 0 -and -not [string]::IsNullOrEmpty($output) -and -not $output.ToString().Contains("ERROR")) {
              $foundryEndpoint = $output.ToString().Trim()
              Write-Host "‚úì Found existing endpoint: $foundryEndpoint" -ForegroundColor Green
          } else {
              $foundryEndpoint = Read-Host "üìç AI Foundry Endpoint: Enter your project endpoint URL (e.g., https://myproject.openai.azure.com/)"
              azd env set bFoundryEndpoint $foundryEndpoint
              Write-Host "‚úì Set AI Foundry endpoint" -ForegroundColor Green
          }
          
          $output = azd env get-value cChatModelName 2>&1
          if ($LASTEXITCODE -eq 0 -and -not [string]::IsNullOrEmpty($output) -and -not $output.ToString().Contains("ERROR")) {
              $chatModel = $output.ToString().Trim()
              Write-Host "‚úì Found existing chat model: $chatModel" -ForegroundColor Green
          } else {
              $chatModel = Read-Host "üí¨ Chat Model: Enter your deployment name (e.g., gpt-4o-mini, gpt-4, gpt-35-turbo)"
              azd env set cChatModelName $chatModel
              Write-Host "‚úì Set chat model: $chatModel" -ForegroundColor Green
          }
          
          $output = azd env get-value dAudioModelName 2>&1
          if ($LASTEXITCODE -eq 0 -and -not [string]::IsNullOrEmpty($output) -and -not $output.ToString().Contains("ERROR")) {
              $audioModel = $output.ToString().Trim()
              Write-Host "‚úì Found existing audio model: $audioModel" -ForegroundColor Green
          } else {
              $audioModel = Read-Host "üéµ Audio Model: Enter your audio deployment name (e.g., gpt-4o-mini-audio-preview)"
              azd env set dAudioModelName $audioModel
              Write-Host "‚úì Set audio model: $audioModel" -ForegroundColor Green
          }
          
          # Auto-detect AI resource details and create bicepparam file (in preprovision)
          Write-Host "üîç DEBUG: Auto-detecting AI resource details..." -ForegroundColor Yellow
          $baseEndpoint = $foundryEndpoint -replace "/models$", ""
          $aiResourceName = ($baseEndpoint -split "://")[1] -split "\." | Select-Object -First 1
          Write-Host "   Base endpoint: $baseEndpoint" -ForegroundColor Gray
          Write-Host "   AI resource name: $aiResourceName" -ForegroundColor Gray
          
          try {
              # Find the AI resource across all accessible resource groups
              $aiResource = az cognitiveservices account list --query "[?name=='$aiResourceName']" | ConvertFrom-Json | Select-Object -First 1
              
              if ($aiResource) {
                  $aiResourceGroup = $aiResource.resourceGroup
                  $aiSubscription = $aiResource.id -split "/" | Select-Object -Index 2
                  
                  Write-Host "‚úÖ Found AI resource:" -ForegroundColor Green
                  Write-Host "   Name: $aiResourceName" -ForegroundColor Gray
                  Write-Host "   Resource Group: $aiResourceGroup" -ForegroundColor Gray
                  Write-Host "   Subscription: $aiSubscription" -ForegroundColor Gray
                  
                  azd env set eAISubscriptionId $aiSubscription
                  azd env set fAIResourceGroup $aiResourceGroup
              } else {
                  Write-Host "‚ö†Ô∏è  Could not find AI resource '$aiResourceName'. Using fallback values." -ForegroundColor Yellow
                  $aiResourceGroup = "niteshjain_aifoundary_rg"
                  $aiSubscription = "1b147013-4b92-4753-90d0-35bafcd3e4c8"
                  azd env set eAISubscriptionId $aiSubscription
                  azd env set fAIResourceGroup $aiResourceGroup
              }
          } catch {
              Write-Host "‚ö†Ô∏è  Error looking up AI resource. Using fallback values." -ForegroundColor Yellow
              $aiResourceGroup = "niteshjain_aifoundary_rg"
              $aiSubscription = "1b147013-4b92-4753-90d0-35bafcd3e4c8"
              azd env set eAISubscriptionId $aiSubscription
              azd env set fAIResourceGroup $aiResourceGroup
          }
          
          # Create Bicep parameters file NOW (in preprovision) - THIS IS THE KEY FIX!
          $bicepParamContent = "using './main.bicep'`n`nparam aSetupChoice = '$setupChoice'`nparam bFoundryEndpoint = '$foundryEndpoint'`nparam cChatModelName = '$chatModel'`nparam dAudioModelName = '$audioModel'`nparam eAISubscriptionId = '$aiSubscription'`nparam fAIResourceGroup = '$aiResourceGroup'"
          Set-Content -Path "infra/main.bicepparam" -Value $bicepParamContent
          
          Write-Host ""
          Write-Host "‚úÖ Parameters configured:" -ForegroundColor Green
          Write-Host "   Setup: $setupChoice" -ForegroundColor Cyan
          Write-Host "   Endpoint: $foundryEndpoint" -ForegroundColor Cyan
          Write-Host "   Chat Model: $chatModel" -ForegroundColor Cyan  
          Write-Host "   Audio Model: $audioModel" -ForegroundColor Cyan
          Write-Host "   üìÑ Created infra/main.bicepparam (in preprovision)" -ForegroundColor Cyan
          Write-Host ""
      } else {
          # Collect model names for new deployments
          $chatModel = $null
          $audioModel = $null
          
          $output = azd env get-value cChatModelName 2>&1
          if ($LASTEXITCODE -eq 0 -and -not [string]::IsNullOrEmpty($output) -and -not $output.ToString().Contains("ERROR")) {
              $chatModel = $output.ToString().Trim()
              Write-Host "‚úì Found existing chat model config: $chatModel" -ForegroundColor Green
          } else {
              $chatModel = Read-Host "üí¨ Chat Model: Enter model to deploy [gpt-4o-mini/gpt-4o/gpt-35-turbo]"
              if ([string]::IsNullOrEmpty($chatModel)) {
                  Write-Host "‚ùå Chat model name is required" -ForegroundColor Red
                  exit 1
              }
              azd env set cChatModelName $chatModel
              Write-Host "‚úì Set chat model: $chatModel" -ForegroundColor Green
          }
          
          $output = azd env get-value dAudioModelName 2>&1
          if ($LASTEXITCODE -eq 0 -and -not [string]::IsNullOrEmpty($output) -and -not $output.ToString().Contains("ERROR")) {
              $audioModel = $output.ToString().Trim()
              Write-Host "‚úì Found existing audio model config: $audioModel" -ForegroundColor Green
          } else {
              $audioModel = Read-Host "üéµ Audio Model: Enter audio model to deploy [gpt-4o-mini-audio-preview/gpt-4o-audio-preview]"
              if ([string]::IsNullOrEmpty($audioModel)) {
                  Write-Host "‚ùå Audio model name is required" -ForegroundColor Red
                  exit 1
              }
              azd env set dAudioModelName $audioModel
              Write-Host "‚úì Set audio model: $audioModel" -ForegroundColor Green
          }
          
          Write-Host ""
          Write-Host "‚úÖ New deployment parameters configured:" -ForegroundColor Green
          Write-Host "   Setup: $setupChoice" -ForegroundColor Cyan
          Write-Host "   Chat Model: $chatModel" -ForegroundColor Cyan  
          Write-Host "   Audio Model: $audioModel" -ForegroundColor Cyan
          Write-Host ""
      }
      
      # Collect AI location for new deployments (for regional model availability)
      if ($setupChoice -eq "new") {
          $aiLocation = $null
          $output = azd env get-value eAILocation 2>&1
          if ($LASTEXITCODE -eq 0 -and -not [string]::IsNullOrEmpty($output) -and -not $output.ToString().Contains("ERROR")) {
              $aiLocation = $output.ToString().Trim()
              Write-Host "‚úì Found existing AI location: $aiLocation" -ForegroundColor Green
          } else {
              Write-Host "üìç AI Location: Choose region that supports your selected chat and audio models" -ForegroundColor Cyan
              Write-Host "   Validated regions: eastus, eastus2, swedencentral" -ForegroundColor Green
              do {
                  $aiLocation = Read-Host "üåç AI Region [eastus] (eastus/eastus2/swedencentral)"
                  if ([string]::IsNullOrEmpty($aiLocation)) {
                      $aiLocation = "eastus"
                  }
                  $aiLocation = $aiLocation.ToLower().Trim()
                  $supportedRegions = @("eastus", "eastus2", "swedencentral")
                  if ($aiLocation -notin $supportedRegions) {
                      Write-Host "Please choose eastus, eastus2, or swedencentral - these regions support both models" -ForegroundColor Yellow
                  }
              } while ($aiLocation -notin $supportedRegions)
              azd env set eAILocation $aiLocation
              Write-Host "‚úì Set AI location: $aiLocation" -ForegroundColor Green
          }
      }
      
  postprovision:
    shell: pwsh
    interactive: false
    run: |
      Write-Host "" -ForegroundColor Cyan
      Write-Host "=== DEBUG: POSTPROVISION HOOK START ===" -ForegroundColor Cyan
      Write-Host "Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
      
      # Debug: Show all azd environment variables
      Write-Host "" -ForegroundColor Cyan
      Write-Host "üìä DEBUG: Current azd environment state:" -ForegroundColor Cyan
      try {
          $allEnvVars = @('aSetupChoice', 'bFoundryEndpoint', 'cChatModelName', 'dAudioModelName', 'eAISubscriptionId', 'fAIResourceGroup', 'SERVICE_API_IDENTITY_PRINCIPAL_ID', 'SERVICE_API_NAME', 'AZURE_RESOURCE_GROUP', 'AZURE_INFERENCE_ENDPOINT')
          foreach ($var in $allEnvVars) {
              $value = azd env get-value $var 2>$null
              if ($LASTEXITCODE -eq 0 -and -not [string]::IsNullOrEmpty($value)) {
                  if ($var -like "*Endpoint*" -or $var -like "*Id*") {
                      Write-Host "   $var = $value" -ForegroundColor Gray
                  } else {
                      Write-Host "   $var = $value" -ForegroundColor Gray
                  }
              } else {
                  Write-Host "   $var = <not set>" -ForegroundColor DarkGray
              }
          }
      } catch {
          Write-Host "   Error reading environment variables: $($_.Exception.Message)" -ForegroundColor Yellow
      }
      Write-Host "" -ForegroundColor Cyan
      
      # Automated RBAC setup for existing AI Foundry (runs after infrastructure is deployed)
      try {
          $setupChoice = azd env get-value aSetupChoice
          Write-Host "üîê DEBUG: RBAC Setup - Setup Choice: $setupChoice" -ForegroundColor Cyan
          
          if ($setupChoice -eq "existing") {
              Write-Host "üîê Setting up RBAC for existing AI Foundry..." -ForegroundColor Cyan
              
              # Get required values
              $principalId = azd env get-value SERVICE_API_IDENTITY_PRINCIPAL_ID
              $foundryEndpoint = azd env get-value bFoundryEndpoint
              $aiSubscriptionId = "1b147013-4b92-4753-90d0-35bafcd3e4c8"
              $aiResourceGroup = "niteshjain_aifoundary_rg"
              
              # Extract AI service name from endpoint
              $baseEndpoint = $foundryEndpoint -replace '/models', ''
              $aiServiceName = ($baseEndpoint -split '://')[1] -split '\.' | Select-Object -First 1
              
              # Construct resource scope
              $scope = "/subscriptions/$aiSubscriptionId/resourceGroups/$aiResourceGroup/providers/Microsoft.CognitiveServices/accounts/$aiServiceName"
              
              Write-Host "   Principal: $principalId" -ForegroundColor Green
              Write-Host "   Scope: $scope" -ForegroundColor Green
              
              # Check if role assignment exists
              $existingRoles = az role assignment list --assignee $principalId --scope $scope --role "Cognitive Services OpenAI User" | ConvertFrom-Json
              $existing = $existingRoles.Count
              
              if ($existing -eq "0") {
                  Write-Host "   Creating role assignment..." -ForegroundColor Yellow
                  $result = az role assignment create --role "Cognitive Services OpenAI User" --assignee $principalId --scope $scope
                  Write-Host "   ‚úÖ Role assignment created successfully" -ForegroundColor Green
              } else {
                  Write-Host "   ‚úÖ Role assignment already exists" -ForegroundColor Green
              }
          } else {
              Write-Host "üîê Skipping RBAC setup (not using existing AI Foundry)" -ForegroundColor Gray
          }
      } catch {
          Write-Host "‚ö†Ô∏è RBAC setup failed: $($_.Exception.Message)" -ForegroundColor Yellow
          Write-Host "You can manually create the role assignment later if needed." -ForegroundColor Gray
      }
      
      Write-Host "‚úÖ Postprovision: Bicepparam file was already created in preprovision hook" -ForegroundColor Green
      
  postdeploy:
    shell: pwsh
    run: |
      Write-Host "==============================" -ForegroundColor Cyan
      Write-Host "üöÄ Deployment completed successfully!" -ForegroundColor Green
      
      $setupChoice = azd env get-value aSetupChoice
      if ($setupChoice -eq "existing") {
        Write-Host "‚úÖ Using existing Azure AI Foundry endpoint" -ForegroundColor Yellow
        Write-Host "‚úÖ RBAC permissions configured automatically via Bicep deployment script" -ForegroundColor Green
      } else {
        Write-Host "‚úÖ New Azure AI services provisioned" -ForegroundColor Green
        
        # For new deployments, update app service settings with the newly created AI endpoints
        try {
          Write-Host "üîß Updating App Service with new AI endpoints..." -ForegroundColor Cyan
          
          $appName = azd env get-value SERVICE_API_NAME
          $resourceGroup = azd env get-value AZURE_RESOURCE_GROUP
          
          # Get AI resource information from the deployment
          Write-Host "   Getting AI resource information..." -ForegroundColor Gray
          
          # Query for the newly created AI service
          $aiServices = az cognitiveservices account list --resource-group $resourceGroup --query "[?kind=='AIServices']" | ConvertFrom-Json
          
          if ($aiServices -and $aiServices.Count -gt 0) {
              $aiService = $aiServices[0]
              $aiEndpoint = "$($aiService.properties.endpoint)models"
              $aiResourceId = $aiService.id
              
              Write-Host "   AI Service: $($aiService.name)" -ForegroundColor Green
              Write-Host "   Endpoint: $aiEndpoint" -ForegroundColor Green
              
              # Update app service settings
              az webapp config appsettings set --name $appName --resource-group $resourceGroup --settings "AZURE_EXISTING_AIPROJECT_RESOURCE_ID=$aiResourceId" "EXISTING_AI_FOUNDRY_ENDPOINT=$aiEndpoint" "AZURE_INFERENCE_ENDPOINT=$aiEndpoint" --output none
              
              Write-Host "‚úÖ App Service settings updated with new AI endpoints" -ForegroundColor Green
          } else {
              Write-Host "‚ö†Ô∏è  Could not find newly created AI service - settings may need manual update" -ForegroundColor Yellow
          }
        } catch {
          Write-Host "‚ö†Ô∏è  Failed to update app service settings: $($_.Exception.Message)" -ForegroundColor Yellow
          Write-Host "   You can update the settings manually in the Azure portal" -ForegroundColor Gray
        }
      }
      
      $serviceUri = azd env get-value SERVICE_API_URI
      Write-Host ""
      Write-Host "üåê Application URL: $serviceUri" -ForegroundColor Cyan
      Write-Host "üîß Visit the settings page to configure additional options" -ForegroundColor Gray